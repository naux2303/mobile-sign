<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ‰‹æ©Ÿç°½åè²¼åˆ°ç°½å–®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: #f5f5f5;
      color: #222;
    }

    h1 {
      font-size: 1.3rem;
      margin: 0 0 8px;
      text-align: center;
    }

    .hint {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 12px;
      text-align: center;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
    }

    button, input[type="file"] {
      font-size: 1rem;
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .file-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      font-size: 1rem;
    }

    #bgUpload {
      display: none;
    }

    .canvas-wrapper {
      background: #ddd;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 10px;
    }

    #previewCanvas {
      width: 100%;
      height: auto;
      background: #fff;
      border-radius: 4px;
      touch-action: none; /* æ‰‹æŒ‡æ‹–å‹•æ™‚æ¯”è¼ƒå¥½æ§åˆ¶ */
    }

    .sig-controls {
      display: none; /* æœ‰ç°½åæ‰é¡¯ç¤º */
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
      background: #fff;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .sig-controls-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .arrow-grid {
      display: grid;
      grid-template-columns: repeat(3, 50px);
      grid-template-rows: repeat(3, 40px);
      justify-content: center;
      align-items: center;
      gap: 4px;
    }

    .arrow-grid button {
      font-size: 1.2rem;
      padding: 0.2rem;
    }

    .arrow-grid .empty {
      visibility: hidden;
    }

    .scale-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .scale-row input[type="range"] {
      flex: 1;
    }

    .result-wrapper {
      margin-top: 10px;
      background: #fff;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }

    .result-image {
      width: 100%;
      height: auto;
      margin-top: 6px;
      display: none;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* ç°½åæ¿ Overlay */
    #signPadOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    #signPadOverlay.active {
      display: flex;
    }

    .sign-pad-box {
      background: #fff;
      width: calc(100% - 32px);
      max-width: 900px;
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sign-pad-title {
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
    }

    #signCanvas {
      width: 100%;
      height: 260px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      touch-action: none;
    }

    .sign-pad-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .sign-pad-buttons button {
      flex: 1;
      min-width: 90px;
    }

    .btn-primary {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    .btn-danger {
      background: #ff4d4f;
      color: #fff;
      border-color: #ff4d4f;
    }

    .btn-secondary {
      background: #f0f0f0;
    }

    .small-hint {
      font-size: 0.8rem;
      color: #777;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>ç°½åè²¼åˆ°ç°½å–®ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰</h1>
  <div class="hint">
    <div style="text-align:center; font-size:0.9rem; margin-bottom:10px; color:#333;">
    å¦‚æœæ‚¨ä¸æƒ³ç°½åï¼šé–‹å•Ÿç°½åæ¿å¾Œè«‹æŒ‰ã€Œå–æ¶ˆã€ï¼Œç°½åæ¬„ä½æœƒä¿æŒç©ºç™½ã€‚
    </div>
    æ­¥é©Ÿï¼šâ‘ é¸æ“‡ç°½å–®åœ–ç‰‡ â†’ â‘¡ç°½å â†’ â‘¢æ‹–åˆ°ç°½åæ¬„ä½ â†’ â‘£å„²å­˜åœ–ç‰‡
  </div>

  <div class="toolbar">
    <label class="file-label">
      ğŸ“„ é¸æ“‡ç°½å–®åœ–ç‰‡
      <input type="file" id="bgUpload" accept="image/*" />
    </label>

    <button id="openSignPad" disabled>âœï¸ é–‹å•Ÿç°½åæ¿</button>
    <button id="saveImage" disabled>ğŸ’¾ å„²å­˜æˆåœ–ç‰‡</button>
  </div>

  <div class="canvas-wrapper">
    <canvas id="previewCanvas"></canvas>
  </div>

  <div id="sigControls" class="sig-controls">
    <div class="sig-controls-title">ç°½åä½ç½®èˆ‡å¤§å°èª¿æ•´</div>
    <div class="small-hint">å¯ä»¥ç”¨æ‰‹æŒ‡ç›´æ¥æ‹–å‹•ç•«é¢ä¸Šçš„ç°½åï¼Œä¹Ÿå¯ä»¥ç”¨ä¸‹æ–¹æŒ‰éˆ•å¾®èª¿ã€‚</div>

    <div class="arrow-grid">
      <div class="empty"></div>
      <button id="btnUp">â†‘</button>
      <div class="empty"></div>
      <button id="btnLeft">â†</button>
      <div class="empty"></div>
      <button id="btnRight">â†’</button>
      <div class="empty"></div>
      <button id="btnDown">â†“</button>
      <div class="empty"></div>
    </div>

    <div class="scale-row">
      <span>ç¸®å°</span>
      <input type="range" id="scaleRange" min="0.5" max="2.0" step="0.05" value="1" />
      <span>æ”¾å¤§</span>
    </div>
  </div>

  <div class="result-wrapper">
    âœ… ç”¢ç”Ÿå¥½çš„åœ–ç‰‡æœƒé¡¯ç¤ºåœ¨ä¸‹æ–¹ï¼š  
    <div class="small-hint">å¦‚æœæ‰‹æ©Ÿæ²’æœ‰è‡ªå‹•ä¸‹è¼‰ï¼Œè«‹é•·æŒ‰åœ–ç‰‡ â†’ å„²å­˜åˆ°ç›¸ç°¿ã€‚</div>
    <img id="resultImage" class="result-image" alt="ç°½åå®Œæˆåœ–ç‰‡é è¦½" />
  </div>

  <!-- ç°½åæ¿ Overlay -->
  <div id="signPadOverlay">
    <div class="sign-pad-box">
      <div class="sign-pad-title">è«‹åœ¨æ¡†å…§ç°½åï¼ˆç”¨æ‰‹æŒ‡å¯«ï¼‰</div>
      <canvas id="signCanvas"></canvas>
      <div class="sign-pad-buttons">
        <button id="clearSignature" class="btn-danger">æ¸…é™¤é‡ç°½</button>
        <button id="cancelSignature" class="btn-secondary">å–æ¶ˆ</button>
        <button id="useSignature" class="btn-primary">ä½¿ç”¨é€™å€‹ç°½å</button>
      </div>
      <div class="small-hint">å»ºè­°ç°½åœ¨ä¸­é–“ï¼Œç·šæ¢ç•«æ…¢ä¸€é»æœƒæ¯”è¼ƒæ»‘é †ã€‚</div>
      <div class="small-hint" style="color:#444;">
      â€» ä¸æƒ³ç°½åï¼Ÿä¸ç”¨ç•«ï¼Œç›´æ¥æŒ‰ã€Œå–æ¶ˆã€å³å¯ï¼ˆä¸æœƒåŠ å…¥ä»»ä½•ç°½åï¼‰
      </div>
    </div>
  </div>

  <script>
    // === å…¨åŸŸè®Šæ•¸ ===
    const bgInput = document.getElementById('bgUpload');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');

    const openSignBtn = document.getElementById('openSignPad');
    const saveImageBtn = document.getElementById('saveImage');
    const sigControls = document.getElementById('sigControls');
    const scaleRange = document.getElementById('scaleRange');
    const resultImage = document.getElementById('resultImage');

    const btnUp = document.getElementById('btnUp');
    const btnDown = document.getElementById('btnDown');
    const btnLeft = document.getElementById('btnLeft');
    const btnRight = document.getElementById('btnRight');

    // ç°½åæ¿å…ƒç´ 
    const signOverlay = document.getElementById('signPadOverlay');
    const signCanvas = document.getElementById('signCanvas');
    const signCtx = signCanvas.getContext('2d');
    const clearSignatureBtn = document.getElementById('clearSignature');
    const cancelSignatureBtn = document.getElementById('cancelSignature');
    const useSignatureBtn = document.getElementById('useSignature');

    let bgImage = null;              // ç°½å–®èƒŒæ™¯åœ–
    let signatureImage = null;       // å·²ç°½å¥½åå­—çš„åœ–
    let sigPosX = 0;                 // ç°½ååœ¨èƒŒæ™¯ä¸Šçš„ X
    let sigPosY = 0;                 // ç°½ååœ¨èƒŒæ™¯ä¸Šçš„ Y
    let sigScale = 1;                // ç°½åç¸®æ”¾
    let bgLoaded = false;

    let draggingSig = false;
    let lastDragClientX = 0;
    let lastDragClientY = 0;

    // ç°½åæ¿å…§éƒ¨ç‹€æ…‹
    let drawing = false;
    let lastSignX = 0;
    let lastSignY = 0;
    let signWidthCSS = 0;
    let signHeightCSS = 0;

    // === è¼‰å…¥ç°½å–®åœ–ç‰‡ ===
    bgInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          bgImage = img;
          // ç”¨åœ–ç‰‡åŸå§‹å°ºå¯¸ä½œç‚ºç•«å¸ƒå°ºå¯¸ï¼ˆè¼¸å‡ºæ¸…æ™°ï¼‰
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          bgLoaded = true;
          openSignBtn.disabled = false;
          saveImageBtn.disabled = false;
          signatureImage = null;
          sigControls.style.display = 'none';
          resultImage.style.display = 'none';
          render();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // === ä¸»ç•«é¢ï¼šé‡æ–°ç¹ªè£½ ===
    function render() {
      if (!bgLoaded || !bgImage) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

      if (signatureImage) {
        ctx.save();
        ctx.translate(sigPosX, sigPosY);
        ctx.scale(sigScale, sigScale);
        ctx.drawImage(signatureImage, 0, 0);
        ctx.restore();
      }
    }

    // === é–‹å•Ÿç°½åæ¿ ===
    openSignBtn.addEventListener('click', () => {
      if (!bgLoaded) {
        alert('è«‹å…ˆé¸æ“‡ç°½å–®åœ–ç‰‡ã€‚');
        return;
      }
      openSignPad();
    });

    function openSignPad() {
      signOverlay.classList.add('active');

      const margin = 40;
      const maxCanvasHeight = 260; // CSS é«˜åº¦å›ºå®šï¼Œæ–¹ä¾¿é•·è¼©ç°½å
      const boxWidth = window.innerWidth - margin;
      const boxHeight = maxCanvasHeight;

      signWidthCSS = boxWidth;
      signHeightCSS = boxHeight;

      const dpr = window.devicePixelRatio || 1;
      signCanvas.style.width = boxWidth + 'px';
      signCanvas.style.height = boxHeight + 'px';
      signCanvas.width = boxWidth * dpr;
      signCanvas.height = boxHeight * dpr;

      signCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      signCtx.lineWidth = 3.5;
      signCtx.lineCap = 'round';
      signCtx.lineJoin = 'round';
      signCtx.strokeStyle = '#000000';
      // æ¸…ç©ºç•«å¸ƒï¼Œä¿ç•™é€æ˜èƒŒæ™¯
      signCtx.clearRect(0, 0, signWidthCSS, signHeightCSS);
    }

    function closeSignPad() {
      signOverlay.classList.remove('active');
    }

    // === ç°½åæ¿ï¼šç•«ç·š ===
    function getSignPos(evt) {
      const rect = signCanvas.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;
      return { x, y };
    }

    signCanvas.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      drawing = true;
      const pos = getSignPos(e);
      lastSignX = pos.x;
      lastSignY = pos.y;
    });

    signCanvas.addEventListener('pointermove', (e) => {
      if (!drawing) return;
      e.preventDefault();
      const pos = getSignPos(e);
      signCtx.beginPath();
      signCtx.moveTo(lastSignX, lastSignY);
      signCtx.lineTo(pos.x, pos.y);
      signCtx.stroke();
      lastSignX = pos.x;
      lastSignY = pos.y;
    });

    function stopDrawing() {
      drawing = false;
    }

    signCanvas.addEventListener('pointerup', stopDrawing);
    signCanvas.addEventListener('pointercancel', stopDrawing);
    signCanvas.addEventListener('pointerleave', stopDrawing);

    // æ¸…é™¤é‡ç°½
    clearSignatureBtn.addEventListener('click', () => {
      // æ¸…ç©ºç•«å¸ƒï¼Œé‡æ–°è®Šé€æ˜
      signCtx.clearRect(0, 0, signWidthCSS, signHeightCSS);
    });

    // å–æ¶ˆ
    cancelSignatureBtn.addEventListener('click', () => {
      closeSignPad();
    });

    // ä½¿ç”¨é€™å€‹ç°½å
    useSignatureBtn.addEventListener('click', () => {
      const dataUrl = signCanvas.toDataURL('image/png');
      const img = new Image();
      img.onload = () => {
        signatureImage = img;
        // åˆå§‹ä½ç½®æŠ“åœ¨ç°½å–®å³ä¸‹è§’é™„è¿‘
        if (bgImage) {
          sigScale = 0.3; // å…ˆçµ¦ä¸€å€‹å¤§æ¦‚çš„æ¯”ä¾‹ï¼Œä¹‹å¾Œå¯ä»¥ç”¨æ‹‰æ¡¿èª¿
          sigPosX = bgImage.naturalWidth * 0.55;
          sigPosY = bgImage.naturalHeight * 0.7;
        } else {
          sigScale = 1;
          sigPosX = 50;
          sigPosY = 50;
        }
        scaleRange.value = sigScale;
        sigControls.style.display = 'flex';
        render();
      };
      img.src = dataUrl;
      closeSignPad();
    });

    // === ä¸»ç•«é¢ï¼šç”¨æ‰‹æŒ‡æ‹–ç§»ç°½å ===
    canvas.addEventListener('pointerdown', (e) => {
      if (!signatureImage) return;
      e.preventDefault();
      draggingSig = true;
      lastDragClientX = e.clientX;
      lastDragClientY = e.clientY;
      canvas.setPointerCapture(e.pointerId);
    });

    canvas.addEventListener('pointermove', (e) => {
      if (!draggingSig || !signatureImage) return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const scaleFactor = canvas.width / rect.width; // æŠŠè¢å¹•ä¸Šçš„ä½ç§»æ›ç®—æˆç•«å¸ƒåº§æ¨™

      const dxClient = e.clientX - lastDragClientX;
      const dyClient = e.clientY - lastDragClientY;

      sigPosX += dxClient * scaleFactor;
      sigPosY += dyClient * scaleFactor;

      lastDragClientX = e.clientX;
      lastDragClientY = e.clientY;

      render();
    });

    canvas.addEventListener('pointerup', (e) => {
      draggingSig = false;
      try {
        canvas.releasePointerCapture(e.pointerId);
      } catch (err) {}
    });

    canvas.addEventListener('pointercancel', () => {
      draggingSig = false;
    });

    canvas.addEventListener('pointerleave', () => {
      draggingSig = false;
    });

    // === æ–¹å‘éµå¾®èª¿ ===
    const MOVE_STEP = 20; // ä¸€æ¬¡ç§»å‹• 20pxï¼ˆèƒŒæ™¯åŸå§‹å°ºå¯¸åº§æ¨™ï¼‰

    btnUp.addEventListener('click', () => {
      if (!signatureImage) return;
      sigPosY -= MOVE_STEP;
      render();
    });

    btnDown.addEventListener('click', () => {
      if (!signatureImage) return;
      sigPosY += MOVE_STEP;
      render();
    });

    btnLeft.addEventListener('click', () => {
      if (!signatureImage) return;
      sigPosX -= MOVE_STEP;
      render();
    });

    btnRight.addEventListener('click', () => {
      if (!signatureImage) return;
      sigPosX += MOVE_STEP;
      render();
    });

    // === ç¸®æ”¾ ===
    scaleRange.addEventListener('input', (e) => {
      if (!signatureImage) return;
      sigScale = parseFloat(e.target.value);
      render();
    });

    // === å„²å­˜æˆåœ–ç‰‡ ===
    saveImageBtn.addEventListener('click', () => {
      if (!bgLoaded) {
        alert('è«‹å…ˆé¸æ“‡ç°½å–®åœ–ç‰‡ã€‚');
        return;
      }
      // é˜²å‘†ï¼šå·²ç¶“æœ‰ç°½åæ™‚ï¼Œè©¢å•æ˜¯å¦ä¸Ÿæ‰é‡ç°½
      if (signatureImage) {
        const ok = confirm('ç›®å‰å·²ç¶“æœ‰ä¸€å€‹ç°½åï¼Œé‡æ–°ç°½åæœƒè¦†è“‹èˆŠçš„ï¼Œç¢ºå®šè¦é‡ç°½å—ï¼Ÿå¦‚æœä½ æƒ³ä¿ç•™åŸæœ¬çš„ç°½åï¼Œè«‹æŒ‰ã€Œå–æ¶ˆã€ã€‚ï¼ˆç›´æ¥æŒ‰å–æ¶ˆï¼ä¸æœƒæ”¹å‹•ä»»ä½•æ±è¥¿ï¼‰');
        if (!ok) {
          // ä½¿ç”¨è€…æŒ‰ã€Œå–æ¶ˆã€â†’ ä¿ç•™åŸæœ¬ç°½åï¼Œä¸é–‹ç°½åæ¿
          return;
        }
        // ä½¿ç”¨è€…åŒæ„é‡ç°½ â†’ æ¸…æ‰èˆŠç°½åã€éš±è—èª¿æ•´å€
        signatureImage = null;
        sigControls.style.display = 'none';
        render();
      }
      
      openSignPad();
      // åŠ å…¥æµ®æ°´å°æç¤ºæ–‡å­—ï¼ˆä¸æœƒå¯«é€²åŒ¯å‡ºçš„ç°½å PNGï¼‰
      signCtx.save();
      signCtx.globalAlpha = 0.4;
      signCtx.font = "16px sans-serif";
      signCtx.fillStyle = "#333";
      signCtx.fillText("è‹¥è¦å–æ¶ˆç°½å â†’ è«‹æŒ‰ä¸‹æ–¹ã€Œå–æ¶ˆã€æŒ‰éˆ•\nä¿æŒç©ºç™½ï¼ä¸æœƒåŠ å…¥ç°½å", 10, signHeightCSS - 20);
      signCtx.restore();
    });
       
      // ç¢ºä¿ç•«é¢æ˜¯æœ€æ–°ä½ç½®
      render();

      const dataUrl = canvas.toDataURL('image/png');

      // 1) å˜—è©¦è§¸ç™¼ä¸‹è¼‰ï¼ˆæŸäº›æ‰‹æ©Ÿæœƒè·³å‡ºä¸‹è¼‰æç¤ºï¼‰
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = 'signed-slip.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      // 2) åŒæ™‚åœ¨é é¢ä¸‹æ–¹é¡¯ç¤ºé è¦½ï¼Œæ–¹ä¾¿é•·æŒ‰å­˜ç›¸ç°¿
      resultImage.src = dataUrl;
      resultImage.style.display = 'block';

      alert('å·²ç”¢ç”Ÿç°½ååœ–ç‰‡ï¼šå¦‚æœæ²’æœ‰è‡ªå‹•ä¸‹è¼‰ï¼Œè«‹å¾€ä¸‹æ»‘ã€é•·æŒ‰é è¦½åœ–å„²å­˜åˆ°ç›¸ç°¿ã€‚');
    });
  </script>
</body>
</html>


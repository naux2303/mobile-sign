<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ‰‹æ©Ÿç°½åè²¼åˆ°ç°½å–®</title>
  <!--
    viewport è¨­å®šï¼šç¦æ­¢ç¸®æ”¾ï¼ˆmaximum-scale=1.0ï¼‰ï¼Œé¿å…ä½¿ç”¨è€…é›™æŒ‡æ”¾å¤§ç¸®å°
    ä»¥å…å½±éŸ¿ç°½åèˆ‡ç•«å¸ƒåº§æ¨™çš„å°æ‡‰é—œä¿‚ã€‚
  -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <style>
    /*
      === æ•´é«”ç‰ˆé¢ ===
      è®“æ•´å€‹é é¢çœ‹èµ·ä¾†åƒä¸€å¼µç°¡å–®çš„æ‰‹æ©Ÿè¡¨å–®ï¼Œ
      å­—é«”ç”¨ç³»çµ±å­—é«”ï¼Œé¿å…æ‰‹æ©Ÿä¸‹è¼‰ç‰¹æ®Šå­—é«”å¡é “ã€‚
    */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: #f5f5f5;
      color: #222;
    }

    /*
      ç°½åæ¿æ‰“é–‹æ™‚ï¼Œé–ä½æ•´é æ²å‹•ï¼ˆä¸€èˆ¬ç€è¦½å™¨ç”¨ï¼‰ã€‚
      åŠ ä¸Š touch-action: none å¯ä»¥é¿å…åœ¨ç°½åæ™‚ç•«é¢è·Ÿè‘—æ»‘å‹•ã€‚
    */
    body.noscroll {
      overflow: hidden;
      touch-action: none;
    }

    h1 {
      font-size: 1.3rem;
      margin: 0 0 8px;
      text-align: center;
    }

    .hint {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 6px;
      text-align: center;
    }

    .hint-extra {
      text-align: center;
      font-size: 0.9rem;
      margin-bottom: 10px;
      color: #333;
    }

    /*
      åªæœ‰åœ¨ LINE å…§å»ºç€è¦½å™¨æ™‚æ‰æœƒé¡¯ç¤ºçš„æç¤ºæ¢ï¼Œ
      ä¸»è¦æ˜¯æ•™ä½¿ç”¨è€…å¯ä»¥æ”¹ç”¨ã€Œå¤–éƒ¨ç€è¦½å™¨ã€ä¾†ç°½åæœƒæ¯”è¼ƒç©©å®šã€‚
    */
    .line-hint-bar {
      display: none;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
    }

    button,
    input[type="file"] {
      font-size: 1rem;
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .file-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      font-size: 1rem;
    }

    /* çœŸæ­£çš„ <input type="file"> éš±è—ï¼Œåªç•™ä¸‹å¥½çœ‹çš„å¤–è§€æŒ‰éˆ• */
    #bgUpload {
      display: none;
    }

    .canvas-wrapper {
      background: #ddd;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 10px;
    }

    /*
      previewCanvasï¼šé¡¯ç¤ºç°½å–®ï¼‹ç°½åçš„ä¸»ç•«å¸ƒã€‚
      å¯¦éš›è¼¸å‡ºçš„è§£æåº¦ç”± JS è¨­å®š canvas.width / heightï¼Œ
      CSS åªè² è²¬ç­‰æ¯”ä¾‹ç¸®æ”¾åˆ°è¢å¹•å¯¬åº¦ã€‚
    */
    #previewCanvas {
      width: 100%;
      height: auto;
      background: #fff;
      border-radius: 4px;
      touch-action: none; /* æ¸›å°‘æ‰‹æŒ‡æ»‘å‹•æ™‚çš„é è¨­æ²å‹•å¹²æ“¾ */
    }

    /*
      ç°½åä½ç½®èª¿æ•´å€ï¼ˆsig-controlsï¼‰ï¼š
      åªæœ‰åœ¨ã€Œé LINE ç€è¦½å™¨ã€æ‰æœƒé¡¯ç¤ºï¼Œè®“ä½ å¯ä»¥ç”¨æ–¹å‘éµå¾®èª¿ã€‚
      åœ¨ LINE è£¡å‰‡å®Œå…¨éš±è—ï¼Œé¿å…æŒ‰éˆ•è¢«é›™æ“Šæ”¾å¤§ç•«é¢ã€‚
    */
    .sig-controls {
      display: none; /* åˆå§‹éš±è—ï¼Œæœ‰ç°½åä¸”ä¸åœ¨ LINE æ‰é¡¯ç¤º */
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
      background: #fff;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .sig-controls-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .arrow-grid {
      display: grid;
      grid-template-columns: repeat(3, 50px);
      grid-template-rows: repeat(3, 40px);
      justify-content: center;
      align-items: center;
      gap: 4px;
    }

    .arrow-grid button {
      font-size: 1.2rem;
      padding: 0.2rem;
    }

    .arrow-grid .empty {
      visibility: hidden; /* ä¸­é–“ç”¨ä¾†æ’ç‰ˆçš„ç©ºæ ¼ */
    }

    .scale-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .scale-row input[type="range"] {
      flex: 1;
    }

    .result-wrapper {
      margin-top: 10px;
      background: #fff;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }

    .result-image {
      width: 100%;
      height: auto;
      margin-top: 6px;
      display: none; /* ç”Ÿæˆåœ–ç‰‡ä¹‹å‰å…ˆéš±è—ï¼Œç”Ÿæˆå¾Œå†é¡¯ç¤º */
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /*
      === ç°½åæ¿ Overlay ===
      ä½¿ç”¨ fixed + inset:0 è®“ç°½åæ¿å…¨è¢å¹•è¦†è“‹ï¼Œ
      èƒŒæ™¯åŠé€æ˜é»‘é®ç½©ï¼Œç°½åçš„ç™½è‰²æ¡†ç½®ä¸­é¡¯ç¤ºã€‚
    */
    #signPadOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none; /* éœ€è¦ç°½åæ™‚æ‰é¡¯ç¤º */
      align-items: center;
      justify-content: center;
      z-index: 999;

      /* ç›¡é‡é˜»æ­¢ overscroll å°è‡´æ•´é æ»‘å‹•ï¼ˆè¼ƒæ–°çš„ç€è¦½å™¨æœ‰æ”¯æ´ï¼‰ */
      overscroll-behavior: contain;
      touch-action: none;
    }

    #signPadOverlay.active {
      display: flex;
    }

    .sign-pad-box {
      background: #fff;
      width: calc(100% - 32px);
      max-width: 900px;
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sign-pad-title {
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
    }

    .sign-canvas-wrapper {
      position: relative;
      width: 100%;
    }

    /*
      signCanvasï¼šçœŸæ­£åœ¨ä¸Šé¢ç•«ç°½åçš„ç•«å¸ƒã€‚
      å¯¦éš›åƒç´ å¤§å°ç”± JS ä¾ç…§è£ç½® pixel ratio è¨­å®šï¼Œ
      CSS æ§åˆ¶å®ƒåœ¨ç•«é¢ä¸­çš„é¡¯ç¤ºå¤§å°ã€‚
    */
    #signCanvas {
      width: 100%;
      height: 260px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff; /* åªåšè¦–è¦ºç™½åº•ï¼Œå¯¦éš›è¼¸å‡ºä»æ˜¯é€æ˜èƒŒæ™¯ï¼‹ç·šæ¢ */
      touch-action: none;
      display: block;
    }

    .sign-watermark {
      position: absolute;
      left: 50%;
      bottom: 8px;
      transform: translateX(-50%);
      font-size: 0.8rem;
      color: #666;
      text-align: center;
      pointer-events: none; /* ä¸è¦å½±éŸ¿æ›¸å¯« */
      opacity: 0.8;
      line-height: 1.3;
    }

    .sign-pad-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .sign-pad-buttons button {
      flex: 1;
      min-width: 90px;
    }

    .btn-primary {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    .btn-danger {
      background: #ff4d4f;
      color: #fff;
      border-color: #ff4d4f;
    }

    .btn-secondary {
      background: #f0f0f0;
    }

    .small-hint {
      font-size: 0.8rem;
      color: #777;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>ç°½åè²¼åˆ°ç°½å–®ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰</h1>
  <div class="hint">
    æ­¥é©Ÿï¼šâ‘ é¸æ“‡ç°½å–®åœ–ç‰‡ â†’ â‘¡ç°½åå¾Œç¢ºèª â†’ â‘¢ï¼ˆç€è¦½å™¨å¯å¾®èª¿ä½ç½®ï¼‰â†’ â‘£ç”Ÿæˆåœ–ç‰‡ â†’ â‘¤ä¸‹æ»‘å„²å­˜åœ–ç‰‡
  </div>
  <div class="hint-extra">
    é‡ç°½æˆ–åˆªé™¤ï¼šé–‹å•Ÿç°½åæ¿å¾Œå¯ä»¥é‡ç°½ï¼›ä¿æŒç©ºç™½ä¸¦æŒ‰ã€Œå–æ¶ˆã€ï¼Œå¯ä»¥åˆªé™¤ç°½åã€‚
  </div>

  <!--
    åªæœ‰åœ¨ LINE å…§å»ºç€è¦½å™¨æ™‚æ‰æœƒé¡¯ç¤ºã€‚
    ç‚ºäº†ç°¡åŒ–ä½¿ç”¨è€…æ“ä½œï¼Œé€™è£¡åªå»ºè­°ã€Œåœ¨å¤–éƒ¨ç€è¦½å™¨é–‹å•Ÿã€ï¼Œ
    ä¸å†ç‰¹åˆ¥é¼“å‹µæ—‹è½‰è¢å¹•ï¼Œé¿å…ä½¿ç”¨è€…åœ¨ç°½åéç¨‹ä¸­é‚Šå¯«é‚Šè½‰é€ æˆç‰ˆé¢æ”¹è®Šã€‚
  -->
  <div id="lineHint" class="line-hint-bar">
    åµæ¸¬åˆ°æ‚¨æ˜¯ä½¿ç”¨ LINE é–‹å•Ÿç¶²é ã€‚<br>
    åœ¨ LINE å…§ç°½åæœƒè‡ªå‹•è²¼åˆ°å›ºå®šæ¬„ä½ï¼Œç„¡éœ€èª¿æ•´ä½ç½®èˆ‡å¤§å°ã€‚<br>
    è‹¥ç°½åæ™‚ç•«é¢è¦ºå¾—ä¸å¥½å¯«ï¼Œå»ºè­°ï¼šé»å³ä¸Šè§’æˆ–å³ä¸‹è§’ã€Œâ‹¯ã€â†’
    é¸æ“‡ã€Œåœ¨å¤–éƒ¨ç€è¦½å™¨é–‹å•Ÿã€ï¼Œç°½åæœƒæ›´ç©©å®šã€‚
  </div>

  <div class="toolbar">
    <label class="file-label">
      ğŸ“„ é¸æ“‡ç°½å–®åœ–ç‰‡
      <input type="file" id="bgUpload" accept="image/*" />
    </label>

    <button id="openSignPad" disabled>âœï¸ é–‹å•Ÿç°½åæ¿</button>
    <button id="saveImage" disabled>ğŸ’¾ ç”Ÿæˆåœ–ç‰‡</button>
  </div>

  <div class="canvas-wrapper">
    <canvas id="previewCanvas"></canvas>
  </div>

  <!--
    ç°½åä½ç½®èª¿æ•´å€ï¼š
    - é›»è…¦ / ä¸€èˆ¬ç€è¦½å™¨ï¼šç°½å®Œåå¾Œå¯ä»¥å¾®èª¿ä½ç½®èˆ‡å¤§å°ã€‚
    - LINEï¼šä¸é¡¯ç¤ºï¼Œç°½åç›´æ¥è²¼åˆ°å›ºå®šæ¬„ä½ã€‚
  -->
  <div id="sigControls" class="sig-controls">
    <div class="sig-controls-title">ç°½åä½ç½®èˆ‡å¤§å°èª¿æ•´ï¼ˆç€è¦½å™¨å°ˆç”¨ï¼‰</div>
    <div class="small-hint">é›»è…¦æˆ–æ‰‹æ©Ÿç€è¦½å™¨å¯ä»¥ç”¨ä¸‹æ–¹æŒ‰éˆ•å¾®èª¿ä½ç½®èˆ‡å¤§å°ï¼ŒLINE æœƒè‡ªå‹•å›ºå®šä½ç½®ã€‚</div>

    <div class="arrow-grid">
      <div class="empty"></div>
      <button id="btnUp">â†‘</button>
      <div class="empty"></div>
      <button id="btnLeft">â†</button>
      <div class="empty"></div>
      <button id="btnRight">â†’</button>
      <div class="empty"></div>
      <button id="btnDown">â†“</button>
      <div class="empty"></div>
    </div>

    <div class="scale-row">
      <span>ç¸®å°</span>
      <input type="range" id="scaleRange" min="0.5" max="2.0" step="0.05" value="1" />
      <span>æ”¾å¤§</span>
    </div>
  </div>

  <div class="result-wrapper">
    âœ… ç”¢ç”Ÿå¥½çš„åœ–ç‰‡æœƒé¡¯ç¤ºåœ¨ä¸‹æ–¹ï¼š
    <div class="small-hint">è«‹å¾€ä¸‹æ»‘ï¼Œé•·æŒ‰ä¸‹æ–¹åœ–ç‰‡ â†’ å„²å­˜åˆ°ç›¸ç°¿ã€‚</div>
    <img id="resultImage" class="result-image" alt="ç°½åå®Œæˆåœ–ç‰‡é è¦½" />
  </div>

  <!--
    === ç°½åæ¿ Overlay ===
    é€™æ˜¯ä¸€å€‹ç¨ç«‹çš„å…¨è¢å¹•ç°½åå€å¡Šï¼Œç”¨ä¾†æ”¶é›†ä½¿ç”¨è€…æ‰‹å¯«ç°½åï¼Œ
    é—œé–‰å¾Œå†æŠŠç°½åè²¼å›ä¸»ç•«å¸ƒã€‚
  -->
  <div id="signPadOverlay">
    <div class="sign-pad-box">
      <div class="sign-pad-title">è«‹åœ¨æ¡†å…§ç°½åï¼ˆç”¨æ‰‹æŒ‡æ›¸å¯«ï¼‰</div>

      <div class="sign-canvas-wrapper">
        <canvas id="signCanvas"></canvas>
        <div class="sign-watermark">
          åˆªé™¤ç°½åï¼šè«‹ä¿æŒç©ºç™½ä¸¦æŒ‰ä¸‹æ–¹ã€Œå–æ¶ˆã€<br>
          ä¿æŒç©ºç™½ ï¼ ä¸æœƒåŠ å…¥ç°½å
        </div>
      </div>

      <div class="sign-pad-buttons">
        <button id="clearSignature" class="btn-danger">æ¸…é™¤é‡ç°½</button>
        <button id="cancelSignature" class="btn-secondary">å–æ¶ˆ</button>
        <button id="useSignature" class="btn-primary">ä½¿ç”¨é€™å€‹ç°½å</button>
      </div>
      <div class="small-hint">å»ºè­°ç°½åœ¨ä¸­é–“ï¼Œç·šæ¢ç•«æ…¢ä¸€é»æœƒæ¯”è¼ƒæ»‘é †ã€‚</div>
      <div class="small-hint" style="color:#444;">
        â€» å¦‚æœæ±ºå®šä¸è¦ç°½åï¼Œå¯ä»¥ç›´æ¥æŒ‰ã€Œå–æ¶ˆã€ï¼Œä¸æœƒåŠ å…¥ä»»ä½•ç°½åã€‚
      </div>
    </div>
  </div>

  <script>
    // =========================
    //  ä¸€ã€å–å¾—å¸¸ç”¨çš„ DOM å…ƒç´ 
    // =========================

    const bgInput = document.getElementById('bgUpload');           // ä¸Šå‚³ç°½å–®åº•åœ–çš„ <input>
    const canvas = document.getElementById('previewCanvas');       // ä¸»ç•«å¸ƒï¼ˆç°½å–®ï¼‹ç°½åé è¦½ï¼‰
    const ctx = canvas.getContext('2d');                           // ä¸»ç•«å¸ƒ 2D ç¹ªåœ– context

    const openSignBtn = document.getElementById('openSignPad');    // ã€Œé–‹å•Ÿç°½åæ¿ã€æŒ‰éˆ•
    const saveImageBtn = document.getElementById('saveImage');     // ã€Œç”Ÿæˆåœ–ç‰‡ã€æŒ‰éˆ•
    const sigControls = document.getElementById('sigControls');    // ä½ç½®ï¼å¤§å°èª¿æ•´å€å¡Šï¼ˆé LINEï¼‰
    const scaleRange = document.getElementById('scaleRange');      // ç°½åç¸®æ”¾ç”¨çš„æ‹‰æ¡¿
    const resultImage = document.getElementById('resultImage');    // ç”¢ç”Ÿå®Œæˆå¾Œçš„é è¦½åœ–

    const btnUp = document.getElementById('btnUp');                // æ–¹å‘éµï¼šä¸Š
    const btnDown = document.getElementById('btnDown');            // æ–¹å‘éµï¼šä¸‹
    const btnLeft = document.getElementById('btnLeft');            // æ–¹å‘éµï¼šå·¦
    const btnRight = document.getElementById('btnRight');          // æ–¹å‘éµï¼šå³

    // ç°½åæ¿ç›¸é—œå…ƒç´ 
    const signOverlay = document.getElementById('signPadOverlay'); // å…¨è¢å¹•ç°½åæ¿å¤–æ®¼
    const signCanvas = document.getElementById('signCanvas');      // çœŸæ­£ç°½åç”¨çš„ç•«å¸ƒ
    const signCtx = signCanvas.getContext('2d');                   // ç°½åç•«å¸ƒ context
    const clearSignatureBtn = document.getElementById('clearSignature');
    const cancelSignatureBtn = document.getElementById('cancelSignature');
    const useSignatureBtn = document.getElementById('useSignature');

    const lineHintBar = document.getElementById('lineHint');       // LINE æç¤ºæ¢

    // =========================
    //  äºŒã€ç‹€æ…‹è®Šæ•¸
    // =========================

    let bgImage = null;            // ç›®å‰è¼‰å…¥çš„ç°½å–®åº•åœ–ï¼ˆImage ç‰©ä»¶ï¼‰
    let signatureImage = null;     // å·²ç°½åå¾Œè½‰æˆçš„ Imageï¼ˆé€æ˜èƒŒæ™¯ï¼‰
    let sigPosX = 0;               // ç°½ååœ–åœ¨ä¸»ç•«å¸ƒä¸Šçš„ X åº§æ¨™ï¼ˆä»¥åº•åœ–åŸå°ºå¯¸ç‚ºå–®ä½ï¼‰
    let sigPosY = 0;               // ç°½ååœ–åœ¨ä¸»ç•«å¸ƒä¸Šçš„ Y åº§æ¨™
    let sigScale = 1;              // ç°½åç¸®æ”¾æ¯”ä¾‹
    let bgLoaded = false;          // æœ‰æ²’æœ‰æˆåŠŸè¼‰å…¥åº•åœ–

    let draggingSig = false;       // æ˜¯å¦æ­£åœ¨æ‹–å‹•ç°½åï¼ˆåªåœ¨é LINE ç€è¦½å™¨å•Ÿç”¨ï¼‰
    let lastDragClientX = 0;       // æ‹–æ›³ç”¨ï¼šä¸Šä¸€å€‹ pointer çš„ clientX
    let lastDragClientY = 0;       // æ‹–æ›³ç”¨ï¼šä¸Šä¸€å€‹ pointer çš„ clientY

    // ç°½åæ¿å…§éƒ¨ç‹€æ…‹ï¼ˆåªè·Ÿç°½åç•«å¸ƒ signCanvas æœ‰é—œï¼‰
    let drawing = false;           // æ˜¯å¦æ­£åœ¨ç°½å
    let lastSignX = 0;             // ç°½åä¸Šä¸€é»çš„ X
    let lastSignY = 0;             // ç°½åä¸Šä¸€é»çš„ Y
    let signWidthCSS = 0;          // ç°½åç•«å¸ƒåœ¨ CSS ä¸Šçš„å¯¬åº¦ï¼ˆpxï¼‰
    let signHeightCSS = 0;         // ç°½åç•«å¸ƒåœ¨ CSS ä¸Šçš„é«˜åº¦ï¼ˆpxï¼‰

    let isSignPadOpen = false;     // ç°½åæ¿æ˜¯å¦æ‰“é–‹ï¼ˆç”¨ä¾†é–ä½æ•´é  touchmoveï¼‰
    let isInLine = false;          // æ˜¯å¦åœ¨ LINE å…§å»ºç€è¦½å™¨é–‹å•Ÿ

    // =========================
    //  ä¸‰ã€åµæ¸¬æ˜¯å¦åœ¨ LINEï¼Œæ±ºå®šæç¤ºèˆ‡è¡Œç‚º
    // =========================

    document.addEventListener('DOMContentLoaded', () => {
      const ua = navigator.userAgent || '';

      // åˆ©ç”¨ userAgent ä¸Šæ˜¯å¦åŒ…å« "Line" ä¾†åˆ¤æ–· LINE å…§å»ºç€è¦½å™¨
      if (/Line/i.test(ua) && lineHintBar) {
        lineHintBar.style.display = 'block'; // é¡¯ç¤ºæé†’ä½¿ç”¨è€…å¯ä»¥æ”¹ç”¨å¤–éƒ¨ç€è¦½å™¨
        isInLine = true;                     // ç´€éŒ„ç›®å‰è·‘åœ¨ LINE è£¡
      }
    });

    //
    // åœ¨ç°½åæ¿æ‰“é–‹æ™‚ï¼Œé˜»æ­¢å…¨é é¢çš„ touchmoveï¼Œ
    // é€™æ¨£ä½¿ç”¨è€…åœ¨ç°½åæ™‚ç•«é¢ä¸æœƒå› ç‚ºæ»‘å‹•è€Œæ²å‹•æ•´å€‹ç¶²é ã€‚
    // ç‰¹åˆ¥æ˜¯ LINE å…§å»ºç€è¦½å™¨ï¼Œæ²’æœ‰é€™æ®µæœƒå¾ˆå®¹æ˜“æ•´é ä¸€èµ·æ™ƒã€‚
    //
    document.addEventListener('touchmove', (e) => {
      if (isSignPadOpen) {
        e.preventDefault();
      }
    }, { passive: false });

    // =========================
    //  å››ã€è¼‰å…¥ç°½å–®åº•åœ–
    // =========================

    bgInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return; // æ²’é¸æª”å°±ä¸åšäº‹

      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          bgImage = img;                                  // å­˜èµ·ä¾†
          canvas.width = img.naturalWidth;                // ä¸»ç•«å¸ƒå¯¬åº¦ = åº•åœ–åŸå§‹å¯¬åº¦
          canvas.height = img.naturalHeight;              // ä¸»ç•«å¸ƒé«˜åº¦ = åº•åœ–åŸå§‹é«˜åº¦
          bgLoaded = true;

          openSignBtn.disabled = false;                   // å…è¨±é–‹å•Ÿç°½åæ¿
          saveImageBtn.disabled = false;                  // å…è¨±ç”Ÿæˆåœ–ç‰‡

          signatureImage = null;                          // æ›åº•åœ–æ™‚æ¸…æ‰èˆŠç°½å
          sigControls.style.display = 'none';             // éš±è—ä½ç½®èª¿æ•´å€ï¼ˆç­‰ç°½å®Œå†æ±ºå®šè¦ä¸è¦é¡¯ç¤ºï¼‰
          resultImage.style.display = 'none';             // éš±è—èˆŠçš„çµæœåœ–

          render();                                       // é‡æ–°ç•«ä¸€æ¬¡åº•åœ–
        };
        img.src = ev.target.result;                       // è®€å…¥çš„æª”æ¡ˆè½‰æˆ dataURL ç•¶ä½œåœ–ç‰‡ä¾†æº
      };
      reader.readAsDataURL(file);                          // å°‡æª”æ¡ˆè®€æˆ base64 dataURL
    });

    // =========================
    //  äº”ã€ä¸»ç•«å¸ƒé‡ç¹ªå‡½å¼
    // =========================

    function render() {
      if (!bgLoaded || !bgImage) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return; // å°šæœªè¼‰å…¥åº•åœ– â†’ ç•«å¸ƒä¿æŒç©ºç™½
      }

      // 1. å…ˆæ¸…ç©ºæ•´å€‹ç•«å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 2. ç•«ç°½å–®åº•åœ–
      ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

      // 3. å¦‚æœç›®å‰æœ‰ç°½åï¼Œæ‰æŠŠç°½åç–Šä¸Šå»
      if (signatureImage) {
        ctx.save();
        ctx.translate(sigPosX, sigPosY);   // å°‡åŸé»ç§»åˆ°ç°½åçš„å·¦ä¸Šè§’ä½ç½®
        ctx.scale(sigScale, sigScale);     // å¥—ç”¨ç¸®æ”¾
        ctx.drawImage(signatureImage, 0, 0); // æŠŠç°½ååœ–ç•«ä¸Šå»ï¼ˆç°½ååœ–æœ¬èº«æ˜¯é€æ˜èƒŒæ™¯ï¼‰
        ctx.restore();
      }
    }

    // =========================
    //  å…­ã€é–‹å•Ÿ / é—œé–‰ç°½åæ¿
    // =========================

    // æŒ‰ä¸‹ã€Œé–‹å•Ÿç°½åæ¿ã€çš„é‚è¼¯
    openSignBtn.addEventListener('click', () => {
      if (!bgLoaded) {
        alert('è«‹å…ˆé¸æ“‡ç°½å–®åœ–ç‰‡ã€‚');
        return;
      }

      // è‹¥å·²ç¶“æœ‰ç°½åï¼Œå…ˆåšé˜²å‘†ï¼šé¿å…èª¤è§¸é–‹å•Ÿç°½åæ¿å°±æ”¹æ‰åŸæœ¬çš„ç°½å
      if (signatureImage) {
        const ok = confirm(
          'ç›®å‰å·²ç¶“æœ‰ä¸€å€‹ç°½åã€‚\n\n' +
          'å¦‚æœä½ æƒ³é‡æ–°ç°½æˆ–åˆªé™¤ç¾åœ¨çš„ç°½åï¼Œè«‹æŒ‰ã€Œç¢ºå®šã€ã€‚\n' +
          'å¦‚æœæƒ³ä¿ç•™ç¾åœ¨çš„ç°½åï¼Œè«‹æŒ‰ã€Œå–æ¶ˆã€ã€‚'
        );
        if (!ok) {
          // ä½¿ç”¨è€…æƒ³ä¿ç•™èˆŠç°½å â†’ ä»€éº¼éƒ½ä¸åš
          return;
        }
        // æ¸…é™¤èˆŠç°½åèˆ‡èª¿æ•´å€
        signatureImage = null;
        sigControls.style.display = 'none';
        render();
      }

      openSignPad();
    });

    // å¯¦éš›é–‹å•Ÿç°½åæ¿çš„å‡½å¼
    function openSignPad() {
      signOverlay.classList.add('active');     // é¡¯ç¤ºå…¨è¢å¹•ç°½å overlay
      document.body.classList.add('noscroll'); // é–ä½èƒŒæ™¯æ²å‹•
      isSignPadOpen = true;

      // ä¾ç…§ç•«é¢å¯¬åº¦è¨­å®šç°½åç•«å¸ƒå¤§å°ï¼ˆæ¯æ¬¡æ‰“é–‹éƒ½é‡æ–°è¨ˆç®—ä¸€æ¬¡ï¼‰
      const wrapper = signCanvas.parentElement; // .sign-canvas-wrapper
      const boxWidth = wrapper.clientWidth;     // ç•¶ä¸‹å¯ç”¨å¯¬åº¦
      const boxHeight = 260;                    // å›ºå®šé«˜åº¦ï¼Œæ‰‹æ©Ÿç°½åçš„æ‰‹æ„Ÿæ¯”è¼ƒç©©

      signWidthCSS = boxWidth;
      signHeightCSS = boxHeight;

      // æ ¹æ“šè£ç½® pixel ratio è¨­å®šå¯¦éš›ç•«å¸ƒè§£æåº¦ï¼Œé¿å…ç•«é¢ç³Šæ‰
      const dpr = window.devicePixelRatio || 1;
      signCanvas.style.width = boxWidth + 'px';
      signCanvas.style.height = boxHeight + 'px';
      signCanvas.width = boxWidth * dpr;
      signCanvas.height = boxHeight * dpr;

      // æŠŠç•«å¸ƒåº§æ¨™ç³»çµ±èª¿æ•´å›ã€Œä»¥ CSS pixel ç‚ºå–®ä½ã€çš„åº§æ¨™ï¼Œå¯«èµ·ä¾†æ¯”è¼ƒç›´è¦º
      signCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      signCtx.lineWidth = 3.5;      // ç°½åç·šçš„ç²—ç´°
      signCtx.lineCap = 'round';    // ç·šé ­åœ“è§’ï¼Œæ‰‹å¯«æœƒæ¯”è¼ƒé †
      signCtx.lineJoin = 'round';   // æŠ˜ç·šéŠœæ¥è™•åœ“è§’
      signCtx.strokeStyle = '#000000';

      // æ¸…ç©ºç•«å¸ƒå…§å®¹ï¼ˆä¿æŒé€æ˜ï¼Œåªç•«ç·šï¼‰
      signCtx.clearRect(0, 0, signWidthCSS, signHeightCSS);
    }

    // é—œé–‰ç°½åæ¿ï¼šé—œé–‰ overlayï¼‹æ¢å¾© body æ²å‹•
    function closeSignPad() {
      signOverlay.classList.remove('active');
      document.body.classList.remove('noscroll');
      isSignPadOpen = false;
    }

    // =========================
    //  ä¸ƒã€ç°½åç•«å¸ƒï¼šåµæ¸¬åº§æ¨™èˆ‡ç•«ç·š
    // =========================

    // å°‡ pointer äº‹ä»¶çš„ clientX / clientY è½‰æˆç•«å¸ƒå…§çš„åº§æ¨™
    function getSignPos(evt) {
      const rect = signCanvas.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;
      return { x, y };
    }

    // pointerdownï¼šé–‹å§‹ç°½å
    signCanvas.addEventListener('pointerdown', (e) => {
      e.preventDefault();        // é˜»æ­¢ç€è¦½å™¨é è¨­è¡Œç‚ºï¼ˆé¿å…æ‹‰é¸æ–‡å­—æˆ–æ²å‹•ï¼‰
      drawing = true;            // é€²å…¥ç°½åç‹€æ…‹
      const pos = getSignPos(e);
      lastSignX = pos.x;
      lastSignY = pos.y;
    });

    // pointermoveï¼šç°½åé€²è¡Œä¸­ï¼Œä¸æ–·å¾ä¸Šä¸€é»ç•«åˆ°æ–°ä½ç½®
    signCanvas.addEventListener('pointermove', (e) => {
      if (!drawing) return;      // æ²’æœ‰åœ¨ç°½åå°±å¿½ç•¥
      e.preventDefault();
      const pos = getSignPos(e);
      signCtx.beginPath();
      signCtx.moveTo(lastSignX, lastSignY);
      signCtx.lineTo(pos.x, pos.y);
      signCtx.stroke();
      lastSignX = pos.x;
      lastSignY = pos.y;
    });

    // pointerup / cancel / leaveï¼šçµæŸç°½å
    function stopDrawing() {
      drawing = false;
    }

    signCanvas.addEventListener('pointerup', stopDrawing);
    signCanvas.addEventListener('pointercancel', stopDrawing);
    signCanvas.addEventListener('pointerleave', stopDrawing);

    // ã€Œæ¸…é™¤é‡ç°½ã€ï¼šæŠŠç°½åæ¿å…§å®¹æ¸…ç©º
    clearSignatureBtn.addEventListener('click', () => {
      signCtx.clearRect(0, 0, signWidthCSS, signHeightCSS);
    });

    // ã€Œå–æ¶ˆã€ï¼šé—œé–‰ç°½åæ¿ï¼Œä¸å¯«å…¥ä¸»ç•«å¸ƒã€‚å¦‚æœç°½åæ˜¯ç©ºç™½ï¼Œç­‰åŒæ–¼åˆªé™¤ç°½åã€‚
    cancelSignatureBtn.addEventListener('click', () => {
      closeSignPad();
    });

    // =========================
    //  å…«ã€ç°½åå®Œæˆï¼Œè²¼åˆ°ä¸»ç•«å¸ƒ
    // =========================

    // å°‡ç°½åç•«å¸ƒè½‰æˆ PNG dataURLï¼Œå†è¼‰å…¥æˆé€æ˜èƒŒæ™¯çš„ Image
    useSignatureBtn.addEventListener('click', () => {
      const dataUrl = signCanvas.toDataURL('image/png'); // é€æ˜èƒŒæ™¯ + é»‘ç·š
      const img = new Image();

      img.onload = () => {
        signatureImage = img; // è¨˜ä½é€™å¼µç°½ååœ–ï¼Œä¹‹å¾Œ render() æœƒæŠŠå®ƒç–Šåˆ°åº•åœ–ä¸Š

        if (bgImage) {
          // â˜…â˜… å›ºå®šç°½åæ¬„ä½è¨­å®šå€ â˜…â˜…
          // ä»¥ä¸‹ä¸‰å€‹æ•¸å­—å°±æ˜¯ã€Œç°½åæ¬„ä½ã€ï¼š
          //   - sigScaleï¼šç°½åå¤§å°
          //   - 0.62   ï¼šç°½åå·¦ä¸Šè§’ X åº§æ¨™ï¼ˆå æ•´å¼µå¯¬åº¦çš„æ¯”ä¾‹ï¼‰
          //   - 0.70   ï¼šç°½åå·¦ä¸Šè§’ Y åº§æ¨™ï¼ˆå æ•´å¼µé«˜åº¦çš„æ¯”ä¾‹ï¼‰
          // ä½ ä¹‹å¾Œå¦‚æœæƒ³å¾®èª¿ï¼Œåªè¦æ”¹é€™ä¸‰å€‹æ•¸å­—å³å¯ã€‚
          sigScale = 0.3;                              // ç°½åç¸®æ”¾æˆåŸæœ¬çš„ 30%
          sigPosX = bgImage.naturalWidth * 0.7;       // é å³ä¸€é»çš„ X ä½ç½®
          sigPosY = bgImage.naturalHeight * 0.68;       // åº•éƒ¨åä¸Šçš„ Y ä½ç½®
        } else {
          // ç†è«–ä¸Šä¸æœƒé€²ä¾†ï¼ˆå› ç‚ºæ²’åº•åœ–æ™‚ä¸èƒ½é–‹ç°½åæ¿ï¼‰ï¼Œä¿éšªå¯«æ³•
          sigScale = 1;
          sigPosX = 50;
          sigPosY = 50;
        }

        // åŒæ­¥æ›´æ–°ç¸®æ”¾æ‹‰æ¡¿çš„æ•¸å€¼ï¼Œæ–¹ä¾¿åœ¨ç€è¦½å™¨ä¸­å¾®èª¿
        scaleRange.value = sigScale;

        // åœ¨ LINE è£¡ä¸é¡¯ç¤º sigControlsï¼Œé¿å…æ–¹å‘éµè¢«èª¤åˆ¤æˆé›™æ“Šæ”¾å¤§
        if (!isInLine) {
          sigControls.style.display = 'flex';
        }

        render(); // é‡æ–°ç•«ä¸€æ¬¡ä¸»ç•«å¸ƒï¼ˆåº•åœ– + ç°½åï¼‰
      };

      img.src = dataUrl; // é–‹å§‹è¼‰å…¥ç°½ååœ–ç‰‡
      closeSignPad();    // å¯ä»¥é—œé–‰ç°½åæ¿äº†
    });

    // =========================
    //  ä¹ã€ä¸»ç•«å¸ƒï¼šæ‹–å‹•ç°½åï¼ˆç€è¦½å™¨å°ˆç”¨ï¼‰
    // =========================

    canvas.addEventListener('pointerdown', (e) => {
      if (!signatureImage) {
        return; // æ²’æœ‰ç°½å â†’ è®“ç€è¦½å™¨è‡ªå·±è™•ç†ï¼ˆç…§å¸¸æ²å‹•ç•«é¢ï¼‰
      }

      // å¦‚æœæ˜¯åœ¨ LINE å…§å»ºç€è¦½å™¨ï¼Œå®Œå…¨ä¸å•Ÿç”¨æ‹–å‹•ç°½ååŠŸèƒ½ï¼Œ
      // é¿å…æ‰‹æŒ‡åœ¨ç•«é¢ä¸Šæ»‘å‹•è¢«èª¤åˆ¤ï¼Œå½±éŸ¿ä½¿ç”¨é«”é©—ã€‚
      if (isInLine) {
        return;
      }

      const rect = canvas.getBoundingClientRect();
      const scaleFactor = canvas.width / rect.width; // å°‡è¢å¹•åº§æ¨™æ›ç®—æˆç•«å¸ƒåº§æ¨™

      const x = (e.clientX - rect.left) * scaleFactor;
      const y = (e.clientY - rect.top) * scaleFactor;

      const sigWidth = signatureImage.width * sigScale;
      const sigHeight = signatureImage.height * sigScale;

      const withinX = x >= sigPosX && x <= sigPosX + sigWidth;
      const withinY = y >= sigPosY && y <= sigPosY + sigHeight;

      if (withinX && withinY) {
        // åªæœ‰ã€ŒçœŸçš„é»åœ¨ç°½ååœ–ä¸Šã€æ‰é–‹å§‹æ‹–å‹•ï¼Œé¿å…èª¤è§¸ã€‚
        e.preventDefault();
        draggingSig = true;
        lastDragClientX = e.clientX;
        lastDragClientY = e.clientY;
        canvas.setPointerCapture(e.pointerId);
      } else {
        draggingSig = false; // é»åœ¨å…¶ä»–åœ°æ–¹ â†’ è¦–ç‚ºä¸€èˆ¬æ²å‹•ï¼Œä¸è™•ç†
      }
    });

    canvas.addEventListener('pointermove', (e) => {
      if (!draggingSig || !signatureImage) {
        return; // æ²’åœ¨æ‹–ï¼Œæˆ–æ²’æœ‰ç°½å â†’ ä¸è™•ç†
      }

      e.preventDefault(); // æ­£åœ¨æ‹–ç°½åæ™‚ï¼Œé˜»æ­¢é é¢æ²å‹•

      const rect = canvas.getBoundingClientRect();
      const scaleFactor = canvas.width / rect.width;

      const dxClient = e.clientX - lastDragClientX; // åœ¨è¢å¹•ä¸Šç§»å‹•çš„è·é›¢
      const dyClient = e.clientY - lastDragClientY;

      // è½‰æˆç•«å¸ƒåº§æ¨™å¾Œï¼Œç´¯åŠ åˆ°ç°½åçš„ä½ç½®
      sigPosX += dxClient * scaleFactor;
      sigPosY += dyClient * scaleFactor;

      lastDragClientX = e.clientX;
      lastDragClientY = e.clientY;

      render();
    });

    canvas.addEventListener('pointerup', (e) => {
      draggingSig = false;
      try {
        canvas.releasePointerCapture(e.pointerId);
      } catch (err) {
        // æŸäº›ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æˆ–å·²è‡ªå‹•é‡‹æ”¾ï¼Œå®‰å…¨å¿½ç•¥éŒ¯èª¤
      }
    });

    canvas.addEventListener('pointercancel', () => {
      draggingSig = false;
    });

    canvas.addEventListener('pointerleave', () => {
      draggingSig = false;
    });

    // =========================
    //  åã€æ–¹å‘éµå¾®èª¿ï¼ˆç€è¦½å™¨å°ˆç”¨ï¼‰
    // =========================

    const MOVE_STEP = 20; // ä¸€æ¬¡ç§»å‹• 20pxï¼ˆä»¥åº•åœ–åŸå§‹è§£æåº¦ç‚ºå–®ä½ï¼‰

    btnUp.addEventListener('click', () => {
      if (!signatureImage) return;
      sigPosY -= MOVE_STEP;
      render();
    });

    btnDown.addEventListener('click', () => {
      if (!signatureImage) return;
      sigPosY += MOVE_STEP;
      render();
    });

    btnLeft.addEventListener('click', () => {
      if (!signatureImage) return;
      sigPosX -= MOVE_STEP;
      render();
    });

    btnRight.addEventListener('click', () => {
      if (!signatureImage) return;
      sigPosX += MOVE_STEP;
      render();
    });

    // èª¿æ•´ç¸®æ”¾æ¯”ä¾‹æ»‘æ¡¿
    scaleRange.addEventListener('input', (e) => {
      if (!signatureImage) return;
      sigScale = parseFloat(e.target.value);
      render();
    });

    // =========================
    //  åä¸€ã€å„²å­˜æˆåœ–ç‰‡ï¼ˆé¡¯ç¤ºé è¦½ï¼Œè®“ä½¿ç”¨è€…é•·æŒ‰å„²å­˜ï¼‰
    // =========================

    saveImageBtn.addEventListener('click', () => {
      if (!bgLoaded) {
        alert('è«‹å…ˆé¸æ“‡ç°½å–®åœ–ç‰‡ã€‚');
        return;
      }

      // å…ˆç¢ºä¿ç•«å¸ƒå…§å®¹æ˜¯æœ€æ–°çš„
      render();

      // ä½¿ç”¨ toBlob ç”¢ç”Ÿ PNG æª”æ¡ˆï¼Œå†ç”¨ URL ç”¢ç”Ÿé è¦½åœ–
      canvas.toBlob((blob) => {
        if (!blob) {
          alert('ç”¢ç”Ÿåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚');
          return;
        }

        const url = URL.createObjectURL(blob);

        // åœ¨é é¢ä¸‹æ–¹é¡¯ç¤ºé è¦½ï¼Œè®“ä½¿ç”¨è€…é•·æŒ‰å­˜åœ–åˆ°ç›¸ç°¿
        resultImage.src = url;
        resultImage.style.display = 'block';

        alert('å·²ç”¢ç”Ÿç°½ååœ–ç‰‡ï¼šè«‹å¾€ä¸‹æ»‘åˆ°é é¢ä¸‹æ–¹ï¼Œé•·æŒ‰åœ–ç‰‡å„²å­˜åˆ°ç›¸ç°¿ã€‚');
      }, 'image/png');
    });
  </script>
</body>
</html>




